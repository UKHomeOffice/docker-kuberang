---
kind: pipeline
name: default
type: kubernetes

platform:
  os: linux
  arch: amd64

workspace:
  path: /go/src/github.com/UKHomeOffice/docker-kuberang

steps:
- name: build_smoketest
  pull: if-not-exists
  image: golang:1.9.1
  commands:
  - curl -L https://github.com/Masterminds/glide/releases/download/v0.13.0/glide-v0.13.0-linux-amd64.tar.gz -o - | tar -xzf -
  - linux-amd64/glide install
  - go build -ldflags "-X main.Version=$${DRONE_COMMIT}" -o bin/smoketest
  environment:
    CGO_ENABLED: 0
    GOARCH: amd64
    GOOS: linux

- name: build_docker_image
  pull: if-not-exists
  image: 340268328991.dkr.ecr.eu-west-2.amazonaws.com/acp/dind
  commands:
  - docker build -t kuberang:$${DRONE_COMMIT_SHA} .

- name: image_to_artifactory
  pull: if-not-exists
  image: 340268328991.dkr.ecr.eu-west-2.amazonaws.com/acp/dind
  commands:
  - docker login -u="kuberang-build-bot" -p=$${DOCKER_ARTIFACTORY_PASSWORD} docker.digital.homeoffice.gov.uk
  - docker tag kuberang:$${DRONE_COMMIT_SHA} docker.digital.homeoffice.gov.uk/kuberang:$${DRONE_TAG}
  - docker push docker.digital.homeoffice.gov.uk/kuberang:$${DRONE_TAG}
  environment:
    DOCKER_ARTIFACTORY_PASSWORD:
      from_secret: docker_artifactory_password
  when:
    event:
    - tag

services:
- name: docker
  image: 340268328991.dkr.ecr.eu-west-2.amazonaws.com/acp/dind
...
